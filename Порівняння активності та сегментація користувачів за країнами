# Формування даних для аналізу динаміки створення облікових записів, активності користувачів електронної пошти (надсилання, відкриття, кліки) та поведінкових показників, таких як інтервал надсилання, перевірка облікового запису та статус підписки

![Загальні значення в розрізі країн](images/screenshot_2025-11-03_211803.png)

# Основні метрики по акаунтам
WITH
  metric1 AS (
  SELECT
    DATE(s.date) AS date,
    sp.country,
    a.send_interval,
    a.is_verified,
    a.is_unsubscribed,
    COUNT(DISTINCT a.id) AS account_cnt
  FROM
    `DA.account` a
  JOIN
    `DA.account_session` acs
  ON
    a.id = acs.account_id
  JOIN
    `DA.session` s
  ON
    acs.ga_session_id = s.ga_session_id
  JOIN
    `DA.session_params` sp
  ON
    acs.ga_session_id = sp.ga_session_id
  GROUP BY
    1,
    2,
    3,
    4,
    5 ),

  # Основні метрики по листам
  metric2 AS (
SELECT
  DATE_ADD(DATE(s.date), INTERVAL es.sent_date DAY) AS date,
  sp.country,
  a.send_interval,
  a.is_verified,
  a.is_unsubscribed,
  COUNT(DISTINCT es.id_message) AS sent_msg,
  COUNT(DISTINCT o.id_message) AS open_msg,
  COUNT(DISTINCT ev.id_message) AS visit_msg
FROM
  `DA.email_sent` es
LEFT JOIN
  `DA.email_open` o
ON
  es.id_message = o.id_message
LEFT JOIN
  `DA.email_visit` ev
ON
  es.id_message = ev.id_message
JOIN
  `DA.account` a
ON
  es.id_account = a.id
JOIN
  `DA.account_session` acs
ON
  a.id = acs.account_id
JOIN
  `DA.session` s
ON
  acs.ga_session_id = s.ga_session_id
JOIN
  `DA.session_params` sp
ON
  s.ga_session_id = sp.ga_session_id
GROUP BY
  1,
  2,
  3,
  4,
  5 ),
 
  # Об’єднання розрізів
  metric3 AS (
SELECT
  date,
  country,
  send_interval,
  is_verified,
  is_unsubscribed,
  account_cnt,
  0 AS sent_msg,
  0 AS open_msg,
  0 AS visit_msg
FROM
  metric1
UNION ALL
SELECT
  date,
  country,
  send_interval,
  is_verified,
  is_unsubscribed,
  0 AS account_cnt,
  sent_msg,
  open_msg,
  visit_msg
FROM
  metric2 ),

  # Додаткові метрики total
  metric4 AS (
SELECT
  country,
  SUM(account_cnt) AS total_country_account_cnt,
  SUM(sent_msg) AS total_country_sent_cnt
FROM
  metric3
GROUP BY
  1 ),

  # Додаткові метрики rank
  metric5 AS (
SELECT
  country,
  total_country_account_cnt,
  total_country_sent_cnt,
  RANK() OVER (ORDER BY total_country_account_cnt DESC) AS rank_total_country_account_cnt,
  RANK() OVER (ORDER BY total_country_sent_cnt DESC) AS rank_total_country_sent_cnt
FROM
  metric4)
 
  # Загальний
SELECT
  metric3.date,
  metric3.country,
  metric3.send_interval,
  metric3.is_verified,
  metric3.is_unsubscribed,
  metric3.account_cnt,
  metric3.sent_msg,
  metric3.open_msg,
  metric3.visit_msg,
  metric5.total_country_account_cnt,
  metric5.total_country_sent_cnt,
  metric5.rank_total_country_account_cnt,
  metric5.rank_total_country_sent_cnt
FROM
  metric3
LEFT JOIN
  metric4
ON
  metric3.country = metric4.country
LEFT JOIN
  metric5
ON
  metric3.country = metric5.country
WHERE
  rank_total_country_account_cnt <= 10
  OR rank_total_country_sent_cnt <= 10
